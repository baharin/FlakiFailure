# Automated Test Validators for Flaky Cyber-Physical System Simulators: Approach and Evaluation

In this article, We propose a data-driven approach to constructing test validators â€“ sets of assertions, i.e., arithmetic
and logical predicates over system inputs, that explain the pass or fail outcomes observed in simulation-based testing.
Assertions with high predictive confidence of pass or fail verdicts are likely to delineate input regions corresponding to
nominal or low-risk conditions, violations of ODD boundaries, or unmet preconditions.  We propose two methods for generating assertion-based test validators: one using genetic programming (GP) and the other using interpretable ML techniques, specifically decision trees (DT) and decision rules (DR). Below we briefly describe each step of GenTC, our framework for deriving assertion-based test validators for CPS: 

<p align="center">
  <img src="https://github.com/baharin/FlakiFailure/blob/main/overview.JPG" width="700" height="200" class="centerImage" />
</p>

* <p> <b> Training Data Generation </b> This step uses adaptive random testing to generate a training set of test inputs. To label these test inputs either as pass or fail, they are executed on the SUT. </p>

* <p> <b> Condition Inference </b> This step uses the training set to learn conditions for assertion-based test validators. This step identifies conditions that best explain pass elements or fail elements in the training set. Specifically, in this step, we use alternative techniques to infer conditions from the data. The alternative approaches are Genetic Programming (GP) and ML-based DT and DR techniques. 
  
  * <b> Condition Inference by GP </b> The conditions inferred by GP structurally conform to the following grammar: 

    <p align="center">
      <img src="https://github.com/baharin/FlakiFailure/blob/main/grammar.JPG" width="500" height="100" class="centerImage" />
    </p>
         This grammar generates conditions that are either conjunctions of relational expressions over arithmetic terms or disjunctions of such conjunctions. The relational expressions relate arithmetic expressions, variables and constants.
    </p>

  * <b> Condition Inference by DT/DR </b> DT generates tree-like structure of decisions, while DR establishes a set of if-then rules for classification based on input variables. 

* <p> <b> Test Validator Building </b> describes how assertion-based test validators are constructed using the training set from the first step and the conditions inferred in the second step. This steps involves first deriving confidence levels of assertions by calculating their precisions in classifying pass or fail tests in the training set. Then, we use a pruning mechanism to ensure that the pass and fail assertions are consistent. Our pruning mechanism employs Z3 solver.
</p>

License 
--------------------------------------------
This software is released under GNU GENERAL PUBLIC LICENSE, Version 2. Please refer to the license.txt

Content Description
--------------------------------------------
Folders
-  ``Aircraft``: contains the autopilot benchmark as well as scripts to run adaptive random testing on Aircraft.
-  ``Assertions``: contains the assertions generated by GP with Tarantula, Ochiai, Naish, as well as those generated DT, DR and the ensemble.
-  ``BeamNG``: contains two sub folders ``APSNG-Dave2`` and ``APTWN``. Each folder contains scripts for running the adaptive random testing on ADS setup.
-  ``Code``: contains scripts related to the implementation of all the approaches in this article.
-  ``Datasets``: contains the datasets generated in the Test Generation Step for each test setup: ``Aircraft``, ``Router``, ``AP-SNG``, ``Dave2`` and ``AP-TWN``. For ``AP-TWN``, there is one file for <i>R1</i> and one file for <i>R2</i> to <i>R4</i>.
-  ``Evaluation``: containts three subfolders ``Code``, ``Results`` and ``Testset``. Subfolder ``Code`` contains the codes we used to answer each RQ, subfolder ``Results`` contains the results of each ``RQ``, and subfolder ``testset`` contains the testset we generated to answer RQ2 and RQ3.
-  ``Router``: contains a script to run adaptive random testing on router.


Prerequisite
--------------------------------------------
- Python (3.8.5)
- Matlab R2021b [For Aircraft]
- BeamNG.tech (0.27) [For ADS]
- BeamNGpy (1.25.1) [For ADS]
- Virtual Box 6.1 [For Router]
- Ubuntu 20.04 disc image (https://ubuntu.com/download/desktop) [For Router]
- OpenWrt 19.0.7 (https://downloads.openwrt.org/releases/19.07.8/targets/x86/64/) [For Router]
- nuttcp 8.1.4 (http://nuttcp.net/nuttcp/nuttcp-8.1.4/nuttcp.c) [For Router]
- dpinger (https://github.com/dennypage/dpinger) [For Router]

Instructions to Run the Scripts
--------------------------------------------
<b> Training Data Generation </b>
* <b> Aircraft </b>
  * First follow launch Matlab and add all the subfolders in the ``Aircraft`` folder to the classpath.
  * Excute ``Scripts/executeAPnewHCR``.
* <b> ADS </b>
  * First follow the instructions in the [BeamNG tech documentation](https://documentation.beamng.com/beamng_tech/install/) to install BeamNG.tech
  * For the APSNG and Dave2, we use the implementation of [Cyber-Physical Systems Testing Tool Competition](https://github.com/sbft-cps-tool-competition/cps-tool-competition). We used [Ambiegen](https://dl.acm.org/doi/pdf/10.1145/3526072.3527531) as the road generator. For AP-TWN, we use west_coast_usa map. 
  * Run the scrips in the ``BeamNG`` folder.
* <b> Router </b>
  * We follow the instructions by [Jodat et al.](https://github.com/anonpaper23/testGenStrat) to setup this case-study.
  * Run the scripts in the ``Router`` folder.

<b> Condition Inference </b>
Navigate to the ``Code`` folder which contains subfolders for each condition inference technique. For example, to run the GP technique for the fail class of ADS, execute ``ADS-FailClass.py`` using python. Ensure that the datasets from the ``Datasets`` folder are placed in the same directory as the scripts.
